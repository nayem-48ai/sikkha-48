name: Tnayem48 Universal Runner

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Select Workflow Action'
        required: true
        default: 'build'
        type: choice
        options:
          - build
          - remove
          - preview
          - unzip
  push:
    branches:
      - main

jobs:
  virtual-execute:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Virtual Execution Engine
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTION_TYPE: ${{ github.event.inputs.action_type || 'build' }}
        run: |
          # ‡ßß. ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶•‡ßá‡¶ï‡ßá ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø‡¶§‡ßá ‡¶Ü‡¶®‡¶æ
          BASE_URL="https://raw.githubusercontent.com/nayem-48ai/nayem-48ai/refs/heads/tnx_bd"
          REMOTE_CONTENT=$(curl -sL "$BASE_URL/$ACTION_TYPE")

          # ‡ß®. ‡¶™‡¶æ‡¶á‡¶•‡¶® ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡¶æ‡¶® ‡¶¨‡ßç‡¶≤‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç 'uses' ‡¶è‡¶∞ ‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶á‡¶®‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
          python3 -c "
          import yaml, sys, os

          content = os.getenv('REMOTE_CONTENT', '')
          data = yaml.safe_load(content)
          
          # ‡¶ï‡¶Æ‡¶® ‡¶ó‡¶ø‡¶ü ‡¶ï‡¶®‡¶´‡¶ø‡¶ó
          print('git config --global user.name \"github-actions[bot]\"')
          print('git config --global user.email \"github-actions[bot]@users.noreply.github.com\"')
          print('git config --global --add safe.directory \"$GITHUB_WORKSPACE\"')

          for job in data.get('jobs', {}).values():
              for step in job.get('steps', []):
                  # ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
                  if 'run' in step:
                      print(step['run'])
                  
                  # ‡¶Ø‡¶¶‡¶ø peaceiris/actions-gh-pages ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶≤‡¶ú‡¶ø‡¶ï
                  if 'uses' in step and 'peaceiris/actions-gh-pages' in step['uses']:
                      target_branch = step.get('with', {}).get('publish_branch', 'tnx-bd')
                      target_dir = step.get('with', {}).get('publish_dir', './dist')
                      print(f'''
                      echo \"üöÄ Virtual Deploying to branch: {target_branch}\"
                      cd {target_dir}
                      git init
                      git config user.name \"github-actions[bot]\"
                      git config user.email \"github-actions[bot]@users.noreply.github.com\"
                      git add .
                      git commit -m \"deploy: auto-generated from universal runner\"
                      git push --force \"https://x-access-token:$GH_TOKEN@github.com/$GITHUB_REPOSITORY.git\" master:{target_branch}
                      ''')
          " | bash
