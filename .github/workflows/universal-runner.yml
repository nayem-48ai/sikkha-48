name: Tnayem48 Universal Runner

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  TNxBD: "https://raw.githubusercontent.com/nayem-48ai/nayem-48ai/refs/heads/tnx_bd/build"

jobs:
  execute-logic:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process Workflow
        run: |
          # Git Configuration
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          # yq ইনস্টল করা (যদি না থাকে)
          if ! command -v yq &> /dev/null; then
            sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq
          fi

          # রিমোট ফাইল ডাউনলোড
          curl -sL "$TNxBD" -o remote_wf.yml

          # শুধু 'run' কমান্ডগুলো ফিল্টার করে বের করা এবং null বাদ দেওয়া
          # এখানে select(. != null) ব্যবহার করা হয়েছে যাতে null ভ্যালু না আসে
          yq e '.jobs.*.steps[].run | select(. != null)' remote_wf.yml > universal_script.sh

          # ফাইল চেক: যদি স্ক্রিপ্ট খালি না হয় তবেই রান করবে
          if [ -s universal_script.sh ]; then
            echo "Executing logic..."
            chmod +x universal_script.sh
            bash universal_script.sh
          else
            echo "No 'run' steps found in the remote workflow."
          fi
