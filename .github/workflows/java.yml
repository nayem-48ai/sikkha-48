name: Build Sikkha48 Final JAR (with Obfuscated Assets)

on:
  push:
    branches:
      - main

jobs:
  build-final-jar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js (React Build)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Build React
        run: |
          npm install
          npm run build

      - name: Obfuscate Web Assets (JS/CSS)
        run: |
          npm install -g javascript-obfuscator
          # অ্যান্ড্রয়েডের মতো এখানেও আমরা ডিস্ট্রিবিউশন ফাইলগুলোকে এনক্রিপ্ট করছি
          javascript-obfuscator ./dist/assets --output ./dist/assets --compact true --self-defending true

      - name: Setup Java 8
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '8'

      - name: Create J2ME Structure with Assets
        run: |
          mkdir -p src/javax/microedition/midlet src/javax/microedition/lcdui src/com/sikkha
          # আপনার React এর 'dist' ফোল্ডারটিকে জারের ভেতরে 'assets' হিসেবে নিচ্ছি
          mkdir -p res/assets
          cp -r dist/* res/assets/
          
          # আইকন কপি
          if [ -f "assets/icon.png" ]; then cp assets/icon.png res/icon.png; fi

          # ডামি লাইব্রেরি (কম্পাইল এরর এড়াতে)
          echo 'package javax.microedition.midlet; public abstract class MIDlet { public abstract void startApp(); public abstract void pauseApp(); public abstract void destroyApp(boolean u); public final void notifyDestroyed() {} }' > src/javax/microedition/midlet/MIDlet.java
          echo 'package javax.microedition.lcdui; public class Display { public static Display getDisplay(Object m) { return new Display(); } public void setCurrent(Object d) {} }' > src/javax/microedition/lcdui/Display.java
          echo 'package javax.microedition.lcdui; public class Form { public Form(String t) {} public void append(String s) {} }' > src/javax/microedition/lcdui/Form.java

          # মেইন জাভা ক্লাস - যা আপনার এসেটগুলো চিনিয়ে দেবে
          echo 'package com.sikkha;
          import javax.microedition.midlet.*;
          import javax.microedition.lcdui.*;

          public class Sikkha48 extends MIDlet {
              public void startApp() {
                  Form f = new Form("Sikkha48");
                  f.append("Web Assets Loaded Successfully.");
                  Display.getDisplay(this).setCurrent(f);
              }
              public void pauseApp() {}
              public void destroyApp(boolean u) {}
          }' > src/com/sikkha/Sikkha48.java

      - name: Build & Package Final JAR
        run: |
          mkdir -p bin
          javac -d bin src/javax/microedition/midlet/*.java src/javax/microedition/lcdui/*.java src/com/sikkha/*.java
          
          # ম্যানিফেস্ট ফাইল (নাম এবং ভার্সন ঠিক রাখা)
          echo "Manifest-Version: 1.0
          MIDlet-Name: Sikkha48
          MIDlet-Version: 2.48
          MIDlet-Vendor: Sikkha
          MIDlet-1: Sikkha48, /icon.png, com.sikkha.Sikkha48
          MicroEdition-Profile: MIDP-2.0
          MicroEdition-Configuration: CLDC-1.1" > manifest.mf
          
          # এবার সব ফাইল (ক্লাস + ওয়েব এসেট + আইকন) একসাথে প্যাক করা
          jar cvfm Sikkha48.jar manifest.mf -C bin . -C res .

      - name: Upload Final JAR
        uses: actions/upload-artifact@v4
        with:
          name: Sikkha48-v2.48-Complete
          path: Sikkha48.jar
